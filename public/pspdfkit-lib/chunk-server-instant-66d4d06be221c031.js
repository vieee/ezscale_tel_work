/*!
 * PSPDFKit for Web 2021.4.2 (https://pspdfkit.com/web)
 * 
 * Copyright (c) 2016-2019 PSPDFKit GmbH. All rights reserved.
 * 
 * THIS SOURCE CODE AND ANY ACCOMPANYING DOCUMENTATION ARE PROTECTED BY INTERNATIONAL COPYRIGHT LAW
 * AND MAY NOT BE RESOLD OR REDISTRIBUTED. USAGE IS BOUND TO THE PSPDFKIT LICENSE AGREEMENT.
 * UNAUTHORIZED REPRODUCTION OR DISTRIBUTION IS SUBJECT TO CIVIL AND CRIMINAL PENALTIES.
 * This notice may not be removed from this file.
 * 
 * PSPDFKit uses several open source third-party components: https://pspdfkit.com/acknowledgements/web/
 */
(window.webpackJsonpPSPDFKit=window.webpackJsonpPSPDFKit||[]).push([[60],{957:function(e,t,n){"use strict";n.r(t),n.d(t,"InstantProvider",(function(){return Fe}));var i=n(18),s=n.n(i),a=n(89),r=n.n(a),o=n(7),c=n.n(o),l=n(17),u=n.n(l),d=n(1),h=n.n(d),f=n(8),p=n.n(f),m=n(6),b=n(3),v=n(54),k=n(161),y=n(297),g=n(11),_=n.n(g),C=n(12),j=n.n(C),O=n(5),F=n.n(O);function w(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=F()(e);if(t){var s=F()(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return j()(this,n)}}var I=function(e){_()(n,e);var t=w(n);function n(){return c()(this,n),t.apply(this,arguments)}return n}(m.e({clientId:"",userId:null,presenceContent:{}}));function R(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=F()(e);if(t){var s=F()(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return j()(this,n)}}var x=function(e){_()(n,e);var t=R(n);function n(){return c()(this,n),t.apply(this,arguments)}return n}(m.e({status:"offline",currentClient:null,clients:Object(m.b)()})),S=n(25),P=n.n(S),A=n(82),q=n.n(A),E=n(187),T=n(188),U=function(){function e(t,n){c()(this,e),this.callback=t,this.timerCalc=n,this.timer=null,this.tries=0}return u()(e,[{key:"reset",value:function(){this.tries=0,this.timer&&clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var e=this;this.timer&&clearTimeout(this.timer),this.timer=setTimeout((function(){e.tries=e.tries+1,e.callback()}),this.timerCalc(this.tries+1))}}]),e}(),B=n(15),V="0.0.1",z=0,D=1,H=2,W={name:"PSPDFKit-Web"},L=function(e){return[1e3,2e3][e-1]||5e3},M=function(){function e(t,n){var i=this,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=s.reconnectTimerCalc,r=void 0===a?L:a,o=s.enableReconnect,l=void 0===o||o,u=s.events,d=void 0===u?[]:u;c()(this,e),this.eventEmitter=new T.a(["connect","disconnect","error"].concat(d)),this.serverURL=t,this.authPayload=n,this.socket=null,this.lastRequestId=0,this.requestsWaitingForAnswers=Object(m.b)(),l&&(this.reconnectTimer=new U((function(){i.socket&&(i.socket.close(),i.socket=null),i.connect()}),r)),this.clearAuthenticationInformation()}return u()(e,[{key:"registerEvents",value:function(e){var t;(t=this.eventEmitter.events).push.apply(t,q()(e))}},{key:"connect",value:function(){var e=this;if(!this.socket){var t=new WebSocket(this.serverURL);t.onopen=this.onOpen.bind(this),t.onmessage=this.onMessage.bind(this),t.onerror=function(){e.socket=null,e.eventEmitter.emit("error","Failed to create the WebSocket connection to ".concat(e.serverURL,". ")+"Please check your firewall or proxy settings.")},this.socket=t}}},{key:"disconnect",value:function(){this.socket&&(this.socket.onclose=function(){},this.socket.close(),this.clearAuthenticationInformation(),this.abortOpenRequests(),this.eventEmitter.emit("disconnect"))}},{key:"connectionState",get:function(){switch(this.socket&&this.socket.readyState){case z:return"connecting";case D:return"open";case H:return"closing";default:return"closed"}}},{key:"isAuthenticated",get:function(){return""!==this.clientId}},{key:"sendRequest",value:function(e,t){var n=this;return new Promise((function(i,s){if(n.isAuthenticated&&n.socket){var a=n.nextRequestId(),r=JSON.stringify(t);n.requestsWaitingForAnswers=n.requestsWaitingForAnswers.set(a,{resolve:i,reject:s}),n.socket.send("".concat(a,":").concat(e,":").concat(r))}else s(new b.a("Cannot send request when the connection is not authenticated"))}))}},{key:"on",value:function(e,t){this.eventEmitter.on(e,t)}},{key:"off",value:function(e,t){this.eventEmitter.off(e,t)}},{key:"onOpen",value:function(){var e=this.socket;e&&(e.onerror=this.onError.bind(this),e.onclose=this.onClose.bind(this))}},{key:"onMessage",value:function(e){var t=e.data;if(this.isAuthenticated){var n=this.parseFrame(t);if(n.requestId){var i=n.requestId;Object(B.a)(this.requestsWaitingForAnswers.has(i),"Received a reply with an unknown request ID.");var s=this.requestsWaitingForAnswers.get(i);switch(Object(B.a)(s),n.action){case"ok":s.resolve(n.payload);break;case"error":s.reject(new b.a(n.payload.reason||"Unknown error"));break;default:Object(B.a)(!1,"".concat(n.action," is not a valid request reply"))}this.requestsWaitingForAnswers=this.requestsWaitingForAnswers.delete(i)}else this.eventEmitter.events.includes(n.action)&&this.eventEmitter.emit(n.action,n.payload),this.log("incoming info message",n)}else{var a=this.parseUnauthenticatedFrame(t);switch(a.action){case"hello":this.onHello(a.payload);break;case"authenticated":this.onAuthenticated(a.payload);break;case"error":this.eventEmitter.emit("error",a.payload.reason||"Unknown error")}}}},{key:"onClose",value:function(e){this.clearAuthenticationInformation(),this.abortOpenRequests(),this.reconnectTimer&&this.reconnectTimer.scheduleTimeout(),this.eventEmitter.emit("disconnect"),this.log("close",e)}},{key:"onError",value:function(e){this.reconnectTimer&&this.reconnectTimer.scheduleTimeout(),this.log("error",e)}},{key:"nextRequestId",value:function(){var e=this.lastRequestId+1;return this.lastRequestId=e,e}},{key:"onHello",value:function(e){var t=this.socket;if(2===e.protocol_version){var n={protocol_version:2,client_version:V,client_info:W,auth_payload:this.authPayload};t.send("hello_web:".concat(JSON.stringify(n)))}else t.send("handshake_failed:".concat(JSON.stringify({reason:"protocol_mismatch",protocol_version:2,client_version:V,client_info:W}))),this.eventEmitter.emit("error","protocol_mismatch")}},{key:"onAuthenticated",value:function(e){Object(B.a)(e.client_id,"`authenticated` message has no `client_id`"),this.clientId=e.client_id,this.userId=e.user_id||null,this.eventEmitter.emit("connect",{clientId:this.clientId,userId:this.userId})}},{key:"log",value:function(){if("development"===Object(E.b)()){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];(e=console).log.apply(e,["SYNCConnection"].concat(n))}}},{key:"parseFrame",value:function(e){var t=/^(\d+|info):([a-zA-Z-_]+):(.+)$/.exec(e.toString()),n=P()(t,4),i=n[1],s=n[2],a=n[3],r=null;return"info"!==i&&(r=parseInt(i)),{requestId:r,action:s,payload:JSON.parse(a)}}},{key:"parseUnauthenticatedFrame",value:function(e){var t=/^(hello|authenticated|error):(.+)$/.exec(e.toString()),n=P()(t,3),i=n[1],s=n[2];return{action:i,payload:JSON.parse(s)}}},{key:"abortOpenRequests",value:function(){this.requestsWaitingForAnswers.forEach((function(e){e.reject(new b.a("request aborted"))})),this.requestsWaitingForAnswers=Object(m.b)()}},{key:"clearAuthenticationInformation",value:function(){this.clientId="",this.userId=null}}]),e}(),N=n(36),K=n.n(N);function J(e){return Object(b.k)("string"==typeof e.client_id,"The client payload must have a `client_id`"),Object(b.k)("object"===K()(e.presence),"The client payload must have a `presence`"),new I({clientId:e.client_id,userId:e.user_id,presenceContent:e.presence})}function $(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return G(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return G(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,s=function(){};return{s:s,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,r=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return r=e.done,e},e:function(e){o=!0,a=e},f:function(){try{r||null==n.return||n.return()}finally{if(o)throw a}}}}function G(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var Y=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new x,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:M;c()(this,e),this.state=t,this.connectionClass=n}return u()(e,[{key:"load",value:function(e,t,n){var i=this;return new Promise((function(s,a){i.setState=function(e){i.state=e},i.connection=new i.connectionClass(e,t,{events:["client_presence"]}),i.connection.on("connect",(function(e){var t=new I({clientId:e.clientId,userId:e.userId,presenceContent:n});i.setState(i.state.set("status","online").set("currentClient",t)),i.populateClients(n).then((function(){s(i)})).catch(a)})),i.connection.on("error",(function(e){a(new b.a(e.toString()))})),i.connection.on("client_presence",(function(e){return i.onInfoClientPresence(e)})),i.connection.connect()}))}},{key:"populateClients",value:function(e){var t=this;return new Promise((function(n,i){t.connection.sendRequest("enter_layer",{presence:e}).then((function(e){t.setState(function(e,t){return Object(B.a)(t.clients,"The payload must have a `clients` list"),e.withMutations((function(n){var i,s=Object(m.b)(t.clients.map((function(e){return J(e)})).map((function(e){return[e.clientId,e]}))).set(null===(i=e.currentClient)||void 0===i?void 0:i.clientId,e.currentClient);n.set("clients",s)}))}(t.state,e)),n()})).catch(i)}))}},{key:"onInfoClientPresence",value:function(e){if(this.setState(function(e,t){Object(B.a)("object"==K()(t.clients),"The payload must have `clients`");var n=e.clients.withMutations((function(n){if(t.clients.entered){var i,s=$(t.clients.entered);try{for(s.s();!(i=s.n()).done;){var a=i.value;if(e.clients.has(a.client_id))throw new b.a("The client marked as entered is already known");var r=J(a);n.set(r.clientId,r)}}catch(e){s.e(e)}finally{s.f()}}if(t.clients.updated){var o,c=$(t.clients.updated);try{for(c.s();!(o=c.n()).done;){var l=o.value;Object(B.a)("string"==typeof l.client_id,"The client payload must have a `client_id`"),Object(B.a)("object"===K()(l.presence),"The client payload must have a `presence`");var u=e.clients.get(l.client_id);if(!u)throw new b.a("The client marked as updated is not known");n.set(u.clientId,u.set("presenceContent",l.presence))}}catch(e){c.e(e)}finally{c.f()}}if(t.clients.left){var d,h=$(t.clients.left);try{for(h.s();!(d=h.n()).done;){var f=d.value;if(!e.clients.has(f))throw new b.a("The client marked as left is not known");n.delete(f)}}catch(e){h.e(e)}finally{h.f()}}}));return e.set("clients",n)}(this.state,e)),this.shouldFireClientUpdatesCallback){var t=Object(m.b)();if(e.clients.entered){var n=e.clients.entered.map((function(e){return e.client_id}));t=this.state.clients.filter((function(e){return-1!==n.indexOf(e.clientId)})).toMap()}var i=Object(m.b)();if(e.clients.updated){var s=e.clients.updated.map((function(e){return e.client_id}));i=this.state.clients.filter((function(e){return-1!==s.indexOf(e.clientId)})).toMap()}var a=Object(m.a)();e.clients.updated&&(a=Object(m.a)(e.clients.left)),this.clientUpdatesCallback(t,i,a)}}},{key:"disconnect",value:function(){"offline"!==this.getStatus()&&(this.setState(this.state.set("status","offline")),this.connection.disconnect())}},{key:"getStatus",value:function(){return this.state.status}},{key:"getCurrentClient",value:function(){return this.state.currentClient}},{key:"getClients",value:function(){return this.shouldFireClientUpdatesCallback=!0,this.state.clients}},{key:"updatePresence",value:function(e){var t=this;return new Promise((function(n,i){if("online"!==t.getStatus())return i(new b.a("ClientsPresence is not connected"));t.connection.sendRequest("update_client_presence",{presence:e}).then((function(){t.setState(function(e,t){var n;return e.setIn(["currentClient","presenceContent"],t).setIn(["clients",null===(n=e.currentClient)||void 0===n?void 0:n.clientId,"presenceContent"],t)}(t.state,e)),n(!0)}),(function(){i(new b.a("Unable to update presence"))}))}))}},{key:"onClientUpdates",value:function(e){if("function"!=typeof e)throw new TypeError("callback must be a function");this.clientUpdatesCallback=e}}]),e}(),Z=n(457);function Q(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=F()(e);if(t){var s=F()(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return j()(this,n)}}var X=function(e){_()(n,e);var t=Q(n);function n(){return c()(this,n),t.apply(this,arguments)}return n}(m.e({content:null,attachments:null,id:null,type:null,group:void 0,resolve:function(){},reject:function(){}})),ee=n(404);function te(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=F()(e);if(t){var s=F()(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return j()(this,n)}}var ne=function(e){_()(n,e);var t=te(n);function n(){return c()(this,n),t.apply(this,arguments)}return n}(m.e({requestInfo:null,status:"offline",currentClient:null,localRecordsContents:Object(m.c)(),localRecordsChanges:Object(m.a)(),stagedRecordsChanges:Object(m.a)(),localRecordsRev:0,requiredAttachmentIds:Object(m.g)(),clients:Object(m.b)()})),ie=n(340),se=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new ne,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ee.b;c()(this,e),h()(this,"_recordsUpdatesCallback",(function(){})),h()(this,"_acceptedRecordsResponseCallback",(function(){})),h()(this,"_shouldFireRecordsUpdateCallback",!1),h()(this,"onChanges",(function(e){if(t._shouldFireRecordsUpdateCallback){var n=e.created,i=e.updated,s=e.deleted;t._recordsUpdatesCallback(Object(m.a)(n),Object(m.a)(i),Object(m.a)(s))}})),h()(this,"onAcceptedRecords",(function(e){if(t._shouldFireRecordsUpdateCallback){var n=e.created,i=e.updated,s=e.deleted;t._acceptedRecordsResponseCallback(Object(m.a)(n),Object(m.a)(i),Object(m.a)(s))}})),h()(this,"setOnDocumentHandleConflictCallback",(function(e){if("function"!=typeof e)throw new TypeError("callback must be a function");t._cycle.setOnDocumentHandleConflictCallback(e)})),h()(this,"syncChanges",Object(ie.a)((function(){return t._cycle.nextCycle()}))),this._state=n,this._CycleClass=i}return u()(e,[{key:"getRecords",value:function(){return this._shouldFireRecordsUpdateCallback=!0,this._state.localRecordsContents.map((function(e,t){return{content:e.content,permissions:e.permissions,group:e.group,id:t}})).toList()}},{key:"createRecord",value:function(e,t,n,i){var s=this;return new Promise((function(a,r){var o=new X({id:e,content:t,attachments:n,group:i,type:"created",resolve:a,reject:r});s.enqueueChangeRequest(o)}))}},{key:"updateRecord",value:function(e,t,n){var i=this;return new Promise((function(s,a){if(!i.isKnownRecordId(e))return a(new b.a("Record with ID: ".concat(e," not found.")));var r=new X({id:e,content:t,group:n,type:"updated",resolve:s,reject:a});i.enqueueChangeRequest(r)}))}},{key:"deleteRecord",value:function(e){var t=this;return new Promise((function(n,i){if(!t.isKnownRecordId(e))return i(new b.a("Record with ID: ".concat(e," not found.")));var s=new X({id:e,type:"deleted",resolve:n,reject:i});t.enqueueChangeRequest(s)}))}},{key:"onRecordsUpdates",value:function(e,t){if("function"!=typeof e)throw new TypeError("recordsUpdateCallback must be a function");if("function"!=typeof t)throw new TypeError("acceptedRecordsCallback must be a function");this._recordsUpdatesCallback=e,this._acceptedRecordsResponseCallback=t}},{key:"destroy",value:function(){this._cycle&&this._cycle.destroy()}},{key:"load",value:function(e,t){var n=this,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return new Promise((function(s,a){var r=n.setState.bind(n);n.setState(n._state.set("requestInfo",{serverURL:e,authPayload:t})),n._cycle=new n._CycleClass({getState:function(){return n._state},setState:r,onChanges:n.onChanges,onAcceptedRecords:n.onAcceptedRecords,longPollingTimeout:i?ee.a:0}),n._cycle.nextCycle(0).then((function(){s(n)})).catch(a)}))}},{key:"setState",value:function(e){this._state=e}},{key:"enqueueChangeRequest",value:function(e){var t=Object(Z.a)({oldChanges:this._state.localRecordsChanges,newChanges:Object(m.a)([e])});this.setState(this._state.set("localRecordsChanges",t))}},{key:"isKnownRecordId",value:function(e){function t(t){return"created"===t.type&&t.id===e}var n=this._state.localRecordsContents.has(e),i=!!this._state.localRecordsChanges.find(t),s=!!this._state.stagedRecordsChanges.find(t);return n||i||s}}]),e}(),ae=n(876),re=n(223);function oe(e,t){var n,i=e.get("annotations"),s=e.get("formFields"),a=e.get("comments"),r=e.get("formattedFormFieldValues");return t.id.startsWith("form-field-value/")&&(n=t.id.split("/")[1]),i.get(t.id)||s.find((function(e){return e.id===t.id}))||a.get(t.id)||(n?r.get(n):void 0)}function ce(e,t){return Boolean(oe(e,t))}var le=n(65),ue=n(201),de=n(106),he=n(163),fe=n(2),pe=n(43),me=n(38),be=["id"],ve=["group","permissions"],ke=["id"],ye=["group","permissions"],ge=["id","permissions","group"],_e=["id"],Ce=["id"],je=["id"],Oe=["group","permissions"],Fe=function(){function e(t,n,i){var s=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ae.a;c()(this,e),h()(this,"_existingBookmarksIds",Object(m.g)()),h()(this,"_existingFormFieldsIds",Object(m.g)()),h()(this,"_existingFormFieldValuesIds",Object(m.g)()),h()(this,"_existingCommentIds",Object(m.g)()),h()(this,"_documentHandleConflictCallback",(function(){})),h()(this,"canCreateBackendOrphanWidgets",!0),h()(this,"setDocumentHandleConflictCallback",(function(e){s._documentHandleConflictCallback=e})),h()(this,"setDocumentHandleOutdated",(function(e){s._setDocumentHandleOutdatedCallback=e})),h()(this,"onDocumentHandleConflict",(function(){s._documentHandleConflictCallback&&s._documentHandleConflictCallback(),s._setDocumentHandleOutdatedCallback&&s._setDocumentHandleOutdatedCallback(!0)})),this._serverURL=t,this._documentURL=n,this._authPayload=i,this._settings=a,this._hasLoadedInitialRecords=!1}var t,n,i,a,o,l,d;return u()(e,[{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:se,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Y,i=[];return this._sync=new t,i.push(this._sync.load("".concat(this._documentURL,"/sync"),this._authPayload,this._settings.listenToServerChangesEnabled).catch(b.i)),this._sync.setOnDocumentHandleConflictCallback(this.onDocumentHandleConflict),this._settings.clientsPresenceEnabled&&(this._clients=new n,i.push(this._clients.load("".concat(this._serverURL.replace(/^http/i,"ws"),"/websocket"),this._authPayload,{}).then((function(){var t=e._clients;null!=t&&(t.onClientUpdates((function(){return e._onClientsChange(t.getClients())})),e._onClientsChange(t.getClients()))})).catch((function(e){Object(b.p)("PSPDFKit: An error occurred while initializing the connected clients module. This might be due to a lack of support for WebSockets or a related failure.\n\nFailure details:\n\n"+e.message)})))),Promise.all(i).then((function(){return e})).catch((function(e){throw new b.a("Initialization of PSPDFKit Instant failed:\n".concat(e.message))}))}},{key:"destroy",value:function(){this._sync&&this._sync.destroy()}},{key:"setFormsEnabledInConfig",value:function(e){this._formsEnabledInConfig=e}},{key:"setReadStateCallbacks",value:function(e){this._readStateCallbacks=e}},{key:"setAnnotationCallbacks",value:function(e){this._annotationCallbacks=e}},{key:"setBookmarkCallbacks",value:function(e){this._bookmarkCallbacks=e}},{key:"setFormFieldCallbacks",value:function(e){this._formFieldCallbacks=e}},{key:"setFormFieldValueCallbacks",value:function(e){this._formFieldValueCallbacks=e}},{key:"setCommentCallbacks",value:function(e){this._commentCallbacks=e}},{key:"createAnnotation",value:function(e,t){var n=Object(v.o)(e),i=n.id,s=r()(n,be),a=s.group,o=(s.permissions,r()(s,ve));return this._sync.createRecord(i,o,Object(v.b)(t),a)}},{key:"createComment",value:function(e){var t=Object(v.p)(e),n=t.id,i=r()(t,ke),s=i.group,a=(i.permissions,r()(i,ye));return this._existingCommentIds=this._existingCommentIds.add(n),this._sync.createRecord(n,a,{},s)}},{key:"updateComment",value:(d=s()(p.a.mark((function e(t){return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.updateRecord(Object(v.p)(t));case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),e.t0 instanceof b.a){e.next=10;break}throw e.t0;case 10:case"end":return e.stop()}}),e,this,[[0,6]])}))),function(e){return d.apply(this,arguments)})},{key:"deleteComment",value:function(e){return this._existingCommentIds=this._existingCommentIds.delete(e),this._sync.deleteRecord(e).then((function(){}))}},{key:"setStateGetter",value:function(e){this._getState=e}},{key:"updateRecord",value:(l=s()(p.a.mark((function e(t){var n,i,s,a,o;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.id,s=t.permissions,a=t.group,o=r()(t,ge),!(this._getState&&this._getState()&&null!==(n=this._getState().backend)&&void 0!==n&&n.isCollaborationPermissionsEnabled())){e.next=5;break}return e.abrupt("return",this._sync.updateRecord(i,s.edit?o:void 0,s.setGroup?a:void 0));case 5:return e.abrupt("return",this._sync.updateRecord(i,o,a));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"updateAnnotation",value:(o=s()(p.a.mark((function e(t){return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.updateRecord(Object(v.o)(t));case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),e.t0 instanceof b.a){e.next=10;break}throw e.t0;case 10:case"end":return e.stop()}}),e,this,[[0,6]])}))),function(e){return o.apply(this,arguments)})},{key:"deleteAnnotation",value:function(e){return this._sync.deleteRecord(e.id).then((function(){}))}},{key:"createBookmark",value:function(e){var t=Object(k.b)(e),n=t.id,i=r()(t,_e);return this._existingBookmarksIds=this._existingBookmarksIds.add(n),this._sync.createRecord(n,i,{})}},{key:"updateBookmark",value:(a=s()(p.a.mark((function e(t){var n,i,s;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(k.b)(t),i=n.id,s=r()(n,Ce),e.prev=1,e.next=4,this._sync.updateRecord(i,s);case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(1),e.t0 instanceof b.a){e.next=11;break}throw e.t0;case 11:case"end":return e.stop()}}),e,this,[[1,7]])}))),function(e){return a.apply(this,arguments)})},{key:"deleteBookmark",value:function(e){var t=this;return this._sync.deleteRecord(e).then((function(){t._existingBookmarksIds=t._existingBookmarksIds.delete(e)}))}},{key:"createFormField",value:function(e){var t=Object(v.r)(e),n=t.id,i=r()(t,je),s=i.group,a=(i.permissions,r()(i,Oe));return this._existingFormFieldsIds=this._existingFormFieldsIds.add(n),this._sync.createRecord(n,a,{},s)}},{key:"updateFormField",value:(i=s()(p.a.mark((function e(t){return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.updateRecord(Object(v.r)(t));case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),e.t0 instanceof b.a){e.next=10;break}throw e.t0;case 10:case"end":return e.stop()}}),e,this,[[0,6]])}))),function(e){return i.apply(this,arguments)})},{key:"deleteFormField",value:function(e){var t=this;return this._sync.deleteRecord(e.id).then((function(){t._existingFormFieldsIds=t._existingFormFieldsIds.delete(e.id)}))}},{key:"loadFormFields",value:function(){return this.loadAnnotationsForPageIndex()}},{key:"createFormFieldValue",value:function(e){var t=Object(v.s)(e),n=Object(re.b)(e);return this._existingFormFieldValuesIds=this._existingFormFieldValuesIds.add(n),this._sync.createRecord(n,t,{})}},{key:"setFormFieldValue",value:(n=s()(p.a.mark((function e(t){var n;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(v.s)(t),e.prev=1,e.next=4,this._sync.updateRecord(Object(re.b)(t),n);case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(1),e.t0 instanceof b.a){e.next=11;break}throw e.t0;case 11:case"end":return e.stop()}}),e,this,[[1,7]])}))),function(e){return n.apply(this,arguments)})},{key:"deleteFormFieldValue",value:function(e){var t=this;return this._sync.deleteRecord(e).then((function(){t._existingFormFieldValuesIds=t._existingFormFieldValuesIds.delete(e)}))}},{key:"loadAnnotationsForPageIndex",value:function(){var e=this;return this._loadPromise||(this._loadPromise=new Promise((function(e){return setTimeout(e,0)})).then((function(){e._hasLoadedInitialRecords||(e._sync.onRecordsUpdates((function(t,n,i){return e._onRecordsUpdates(t,n,i,y.b)}),(function(t,n,i){return e._onAcceptedRecords(t,n,i)})),e._onRecordsUpdates(e._sync.getRecords(),Object(m.a)(),Object(m.a)(),y.a),e._hasLoadedInitialRecords=!0)}))),this._loadPromise}},{key:"loadBookmarks",value:(t=s()(p.a.mark((function e(){return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return");case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"syncChanges",value:function(){return this._sync.syncChanges()}},{key:"_filterRecords",value:function(e){var t=this;return e.filter((function(e){var n=e.content;return t._formsEnabledInConfig||!Object(v.l)(n)}))}},{key:"_onRecordsUpdates",value:function(e,t,n,i){var s=this,a=Object(m.a)(),r=[],o=Object(m.a)(),c=Object(m.a)(),l=Object(m.g)(),u=Object(m.g)(),d=Object(m.g)(),h=Object(m.g)(),f=Object(m.g)(),p=this._getState?this._getState():void 0,y=e,g=t,_=n;if(p&&p.backend&&p.backend.isCollaborationPermissionsEnabled()){y=y.filter((function(e){return!!e.content}));var C=[];t.forEach((function(e,t){e.content?ce(p,e)||(y=y.push(e),C.push(t)):ce(p,e)?(_=_.push(e.id),C.push(t)):C.push(t)})),g=g.filter((function(e,t){return!C.includes(t)})),_=_.filter((function(e){return p.annotations.has(e)||s._existingFormFieldValuesIds.has(e)||s._existingFormFieldsIds.has(e)||s._existingCommentIds.has(e)||s._existingBookmarksIds.has(e)}))}var j=Object(m.a)().withMutations((function(e){s._filterRecords(y).forEach((function(t){var n=t.id,i=t.content,l={permissions:t.permissions,group:t.group};try{Object(v.l)(i)?(r.push(Object(v.e)(n,i,l)),s._existingFormFieldsIds=s._existingFormFieldsIds.add(n)):Object(v.m)(i)?(o=o.push(Object(v.f)(i)),s._existingFormFieldValuesIds=s._existingFormFieldValuesIds.add(n)):Object(v.j)(i)?(a=a.push(Object(k.a)(n,i)),s._existingBookmarksIds=s._existingBookmarksIds.add(n)):Object(v.k)(i)?(s._existingCommentIds=s._existingCommentIds.add(n),c=c.push(Object(v.d)(n,i,l))):Object(v.n)(i)||e.push(Object(v.c)(n,i,l))}catch(e){Object(b.j)("Skipped creating record #".concat(n," from payload because an error occurred while deserializing."),i),Object(b.j)(e)}}))})),O=!p||Object(me.p)(p.features,p.signatureFeatureAvailability);r.length>0&&(Object(b.k)(this._formFieldCallbacks),p&&!O?this._formFieldCallbacks.createFormFields(Object(m.a)(r.filter((function(e){return!(e instanceof pe.i)}))),i):this._formFieldCallbacks.createFormFields(Object(m.a)(r),i)),o.size>0&&(Object(b.k)(this._formFieldValueCallbacks),p&&!O&&(o=o.filter((function(e){var t=r.find((function(t){return t.name===e.name}))||p.formFields.get(e.formFieldName);return!(t&&t instanceof pe.i)}))),this._formFieldValueCallbacks.createFormFieldValues(Object(m.a)(o),i)),j.size>0&&(Object(b.k)(this._annotationCallbacks),p&&!O&&(j=j.filter((function(e){if(!(e instanceof fe.fb))return e;var t=r.find((function(t){return t.name===e.formFieldName}))||p.formFields.get(e.formFieldName);return!(t&&t instanceof pe.i)}))),this._annotationCallbacks.createAnnotations(j,Object(m.b)(),i)),c.size>0&&(Object(b.k)(this._commentCallbacks),this._commentCallbacks.createComments(c,i)),a.size>0&&(Object(b.k)(this._bookmarkCallbacks),this._bookmarkCallbacks.createBookmarks(a,i));var F=Object(m.a)().asMutable(),w=[],I=[],R=[],x=Object(m.a)().withMutations((function(e){s._filterRecords(g).map((function(t){var n=t.id,i=t.content,s=t.group,a={permissions:t.permissions,group:s};try{if(Object(v.l)(i))try{w.push(Object(v.e)(n,i,a))}catch(e){d=d.add(n),Object(b.j)("Skipped updating form field #".concat(n," from payload because an error occurred while deserializing. To avoid issues, we have removed the previous version from the application state."),i),Object(b.j)(e)}else if(Object(v.m)(i))try{I.push(Object(v.f)(i))}catch(e){h=h.add(n),Object(b.j)("Skipped updating form field value #".concat(n," from payload because an error occurred while deserializing. To avoid issues, we have removed the previous version from the application state."),i),Object(b.j)(e)}else if(Object(v.j)(i))try{F.push(Object(k.a)(n,i))}catch(e){u=u.add(n),Object(b.j)("Skipped updating bookmark #".concat(n," from payload because an error occurred while deserializing. To avoid issues, we have removed the previous version from the application state."),i),Object(b.j)(e)}else if(Object(v.k)(i))try{R.push(Object(v.d)(n,i,a))}catch(e){f=f.add(n),Object(b.j)("Skipped updating comment #".concat(n," from payload because an error occurred while deserializing. To avoid issues, we have removed the previous version from the application state."),i,e)}else e.push(Object(v.c)(n,i,a))}catch(e){l=l.add(n),Object(b.j)("Skipped updating annotation #".concat(n," from payload because an error occurred while deserializing. To avoid issues, we have removed the previous version from the application state."),i),Object(b.j)(e)}}))}));x.size>0&&(Object(b.k)(this._annotationCallbacks),this._annotationCallbacks.updateAnnotations(x)),F.size>0&&(Object(b.k)(this._bookmarkCallbacks),this._bookmarkCallbacks.updateBookmarks(F)),w.length>0&&(Object(b.k)(this._formFieldCallbacks),this._formFieldCallbacks.updateFormFields(Object(m.a)(w))),I.length>0&&(Object(b.k)(this._formFieldValueCallbacks),this._formFieldValueCallbacks.setFormFieldValues(Object(m.a)(I))),R.length>0&&(Object(b.k)(this._commentCallbacks),this._commentCallbacks.updateComments(Object(m.a)(R))),(l=l.concat(_.filter((function(e){return!(s._existingBookmarksIds.has(e)||s._existingFormFieldsIds.has(e)||s._existingFormFieldValuesIds.has(e)||s._existingCommentIds.has(e))})).toSet())).size>0&&(Object(b.k)(this._annotationCallbacks),this._annotationCallbacks.deleteAnnotations(l)),(u=u.concat(_.filter((function(e){var t=s._existingBookmarksIds.has(e);return t&&(s._existingBookmarksIds=s._existingBookmarksIds.delete(e)),t})).toSet())).size>0&&(Object(b.k)(this._bookmarkCallbacks),this._bookmarkCallbacks.deleteBookmarks(u)),(d=d.concat(_.filter((function(e){var t=s._existingFormFieldsIds.has(e);return t&&(s._existingFormFieldsIds=s._existingFormFieldsIds.delete(e)),t})).toSet())).size>0&&(Object(b.k)(this._formFieldCallbacks),this._formFieldCallbacks.deleteFormFields(d)),(h=h.concat(_.filter((function(e){var t=s._existingFormFieldValuesIds.has(e);return t&&(s._existingFormFieldValuesIds=s._existingFormFieldValuesIds.delete(e)),t})).toSet())).size>0&&(Object(b.k)(this._formFieldValueCallbacks),this._formFieldValueCallbacks.deleteFormFieldValues(h)),(f=f.concat(_.filter((function(e){var t=s._existingCommentIds.has(e);return t&&(s._existingCommentIds=s._existingCommentIds.delete(e)),t})).toSet())).size>0&&(Object(b.k)(this._commentCallbacks),this._commentCallbacks.deleteComments(f))}},{key:"_onAcceptedRecords",value:function(e,t){var n=this._getState?this._getState():void 0;if(n&&n.backend&&n.backend.isCollaborationPermissionsEnabled()){var i=[],s=[],a=[],r=[],o=[],c=[];e.isEmpty()||e.forEach(l),t.isEmpty()||t.forEach(l),i.length>0&&(Object(b.k)(this._annotationCallbacks),this._annotationCallbacks.updateAnnotations(Object(m.a)(i),!0)),s.length>0&&(Object(b.k)(this._commentCallbacks),this._commentCallbacks.updateComments(Object(m.a)(s))),a.length>0&&(Object(b.k)(this._formFieldCallbacks),this._formFieldCallbacks.updateFormFields(Object(m.a)(a))),r.length>0&&(Object(b.k)(this._annotationCallbacks),this._annotationCallbacks.deleteAnnotations(Object(m.g)(r),!0)),o.length>0&&(Object(b.k)(this._commentCallbacks),this._commentCallbacks.deleteComments(Object(m.g)(o))),c.length>0&&(Object(b.k)(this._formFieldCallbacks),this._formFieldCallbacks.deleteFormFields(Object(m.g)(c)))}function l(e){var t={permissions:e.permissions,group:e.group},l=oe(n,e);if(l&&"string"!=typeof l){Object(he.c)(t);var u=Object(he.a)(t);(l=l.merge(u))instanceof le.a?t.permissions&&t.permissions.view?i.push(l):r.push(l.id):l instanceof ue.a?t.permissions&&t.permissions.view?s.push(l):(Object(b.k)(l.id),o.push(l.id)):l instanceof de.a&&(t.permissions&&t.permissions.view?a.push(l):c.push(l.id))}}}},{key:"onClientsChange",value:function(e){if("function"!=typeof e)throw new TypeError("Callback must be a function");this.onClientsChangeCallback=e}},{key:"_onClientsChange",value:function(e){this.onClientsChangeCallback.call(null,e)}}]),e}()}}]);